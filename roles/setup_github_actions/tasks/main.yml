- name: Query GitHub API for self-hosted runners
  uri:
    url: "{{ github_list_runners_url }}"
    method: GET
    headers:
      Authorization: "Bearer {{ github_token }}"
      Accept: "application/vnd.github+json"
    return_content: yes
    status_code: 200
  register: github_response_runner_count

- name: Create fresh runner
  block:
    - name: Request registration token from GitHub API for self-hosted runner
      uri:
        url: "{{ github_get_runner_token_url }}"
        method: POST
        headers:
          Accept: application/vnd.github+json
          Authorization: "Bearer {{ github_token }}"
          X-GitHub-Api-Version: "2022-11-28"
        return_content: yes
        status_code: 201
      register: github_response_runner_token

    - set_fact:
        github_runner_token: "{{ github_response_runner_token.json.token }}"
        github_runner_dir: "{{ github_runner_parent_dir }}/{{ github_runner_name_prefix }}{{ github_runner_name }}"
        tmux_runner_name: "{{ github_runner_name_prefix }}{{ github_runner_name }}"

    - set_fact:
        github_actions_tarball: "{{ github_runner_dir }}/{{ github_action_tar_file }}"

    - include_tasks: subtasks/create_github_actions_dir.yml
    - include_tasks: subtasks/get_github_actions_tarball.yml
    - include_tasks: subtasks/configure_github_actions.yml
    - include_tasks: subtasks/run_github_actions.yml
  when: github_response_runner_count.json.total_count == 0

- include_tasks: subtasks/check_current_runners.yml
  loop: "{{ github_response_runner_count.json.runners }}"
  loop_control:
    loop_var: github_response_runner
    label: "{{ github_response_runner }}"
  when: github_response_runner_count.json.total_count != 0
